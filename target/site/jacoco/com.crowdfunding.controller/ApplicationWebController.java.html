<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="it"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ApplicationWebController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">crowdfunding</a> &gt; <a href="index.source.html" class="el_package">com.crowdfunding.controller</a> &gt; <span class="el_source">ApplicationWebController.java</span></div><h1>ApplicationWebController.java</h1><pre class="source lang-java linenums">package com.crowdfunding.controller;

import java.util.List;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.SessionAttributes;

import com.crowdfunding.model.Fund;
import com.crowdfunding.model.User;
import com.crowdfunding.service.FundService;
import com.crowdfunding.service.UserService;

@Controller
@RequestMapping(&quot;/&quot;)
@SessionAttributes(&quot;user&quot;)
<span class="fc" id="L23">public class ApplicationWebController {</span>

	@Autowired
	private UserService userService;
	
	@Autowired
	private FundService fundService;
	
	@ModelAttribute(&quot;user&quot;)
	public User  setupUserForm() {
<span class="fc" id="L33">		return new User();</span>
	}
	
	@GetMapping(&quot;/&quot;)
	public String index(Model model) {
<span class="fc" id="L38">		return &quot;index&quot;;</span>
	}
	
	
	public String home(Model model, @ModelAttribute(&quot;user&quot;) User user) {
<span class="fc" id="L43">		model.addAttribute(&quot;MODE&quot;, &quot;MODE_HOME&quot;);</span>
<span class="fc" id="L44">		model.addAttribute(&quot;welcomeUser&quot;, &quot;Welcome, &quot; + user.getUsername());</span>
<span class="fc" id="L45">		return &quot;home&quot;;</span>
	}
	
	public String myFunds(Model model, @ModelAttribute(&quot;user&quot;) User user) {
		
<span class="fc" id="L50">		List&lt;Fund&gt; myFunds = fundService.getFundByOwner((user.getId()).intValue());</span>
		
<span class="fc" id="L52">		model.addAttribute(&quot;myFunds&quot;, myFunds);</span>
<span class="fc" id="L53">		model.addAttribute(&quot;MODE&quot;, &quot;MODE_MYFUNDS&quot;);</span>
<span class="fc" id="L54">		model.addAttribute(&quot;activeId&quot;, user.getId());</span>
<span class="fc" id="L55">		model.addAttribute(&quot;MyFundsUser&quot;, &quot;MY FUNDS  -  (Personal ID: &quot; + user.getId() + &quot;, Username: &quot; + user.getUsername() + &quot;)&quot;);</span>
		
		
<span class="fc" id="L58">		return &quot;home&quot;;</span>
	}
	
	public String usersFunds(Model model, @ModelAttribute(&quot;user&quot;) User user) {
		
<span class="fc" id="L63">		List&lt;Fund&gt; usersFunds = fundService.getOpenFundsByOwnerNot((user.getId()).intValue());</span>
		
<span class="fc" id="L65">		model.addAttribute(&quot;usersFunds&quot;, usersFunds);</span>
<span class="fc" id="L66">		model.addAttribute(&quot;MODE&quot;, &quot;MODE_USERSFUNDS&quot;);</span>
		
		
<span class="fc" id="L69">		return &quot;home&quot;;</span>
	}
	
	
	@PostMapping(&quot;/login-user&quot;)
	public String loginUser(Model model, @ModelAttribute(&quot;username&quot;) String username,
			@ModelAttribute(&quot;password&quot;) String password, @ModelAttribute(&quot;user&quot;) User user) {
<span class="fc" id="L76">		User UserFound = userService.getUserByUsernameAndPassword(username, password);</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">		if (UserFound != null) {</span>
<span class="fc" id="L78">			user.setId(UserFound.getId());</span>
<span class="fc" id="L79">			user.setUsername(UserFound.getUsername());</span>
<span class="fc" id="L80">			user.setPassword(UserFound.getPassword());</span>
<span class="fc" id="L81">			user.setRole(UserFound.getRole());</span>
<span class="fc" id="L82">			return home(model, user);</span>
		} else {
<span class="fc" id="L84">			model.addAttribute(&quot;messageLogin&quot;, &quot;Login incorrect or Account not present&quot;);</span>
<span class="fc" id="L85">			return &quot;index&quot;;</span>
		}
	}
	
	@GetMapping(&quot;/action/logout&quot;)
	public String actionLogout(Model model) {
<span class="fc" id="L91">		return &quot;index&quot;;</span>
	}
	
	@GetMapping(&quot;/action/home&quot;)
	public String actionHome(Model model, @ModelAttribute(&quot;user&quot;) User user) {
<span class="fc" id="L96">		return home(model, user);</span>
	}
	
	@GetMapping(&quot;/my-funds&quot;)
	public String ActionMyFunds(Model model, @ModelAttribute(&quot;user&quot;) User user) {
<span class="fc" id="L101">		model.addAttribute(&quot;fund&quot;, new Fund());</span>
<span class="fc" id="L102">		user.setId(user.getId());</span>
<span class="fc" id="L103">		user.setUsername(user.getUsername());</span>
<span class="fc" id="L104">		return myFunds(model, user);</span>
	}
	
	@GetMapping(&quot;/users-funds&quot;)
	public String ActionUsersFunds(Model model, @ModelAttribute(&quot;user&quot;) User user) {
<span class="fc" id="L109">		user.setId(user.getId());</span>
<span class="fc" id="L110">		return usersFunds(model, user);</span>
	}
	
	@GetMapping(&quot;/register&quot;)
	public String register(Model model) {
<span class="fc" id="L115">		model.addAttribute(&quot;user&quot;, new User());</span>
<span class="fc" id="L116">		model.addAttribute(&quot;messageRegister&quot;, &quot;&quot;);</span>
<span class="fc" id="L117">		return &quot;register&quot;;</span>
	}
	
	@PostMapping(&quot;/save-user&quot;)
	public String saveUser(User user, Model model) {
<span class="fc" id="L122">		final User presentUsername = userService.getUserByUsername(user.getUsername());</span>
<span class="fc" id="L123">		user.setUsername(user.getUsername().trim());</span>
<span class="fc" id="L124">		user.setPassword(user.getPassword().trim());</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">		if (presentUsername == null) {</span>
<span class="fc" id="L126">			userService.insertNewUser(user);</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">			if((user.getUsername()).equals(&quot;admin&quot;)) {</span>
<span class="fc" id="L128">				userService.updateRoleToAdmin(user.getId());</span>
			}
<span class="fc" id="L130">			return &quot;redirect:/&quot;;</span>
		} else {
<span class="fc" id="L132">			model.addAttribute(&quot;messageRegister&quot;, &quot;Username already in use! Please change it&quot;);</span>
<span class="fc" id="L133">			return &quot;register&quot;;</span>
		}
	}
	
	@PostMapping(&quot;/save-fund&quot;)
	public String saveFund(Fund fund, Model model, @ModelAttribute(&quot;user&quot;) User user) {
		
<span class="fc" id="L140">		fundService.insertNewFund(fund);</span>
<span class="fc" id="L141">		return myFunds(model, user);</span>
		
	}
		
	@GetMapping(&quot;/myfund/{id_fund}&quot;)
	public String editMyFund(@PathVariable long id_fund, Model model) {
		
<span class="fc" id="L148">		Fund fundById = fundService.getFundById(id_fund);</span>
<span class="fc" id="L149">		model.addAttribute(&quot;fundAttribute&quot;, fundById);</span>
<span class="fc" id="L150">		model.addAttribute(&quot;closable&quot;, &quot;YES&quot;);</span>
		//donate no
<span class="fc bfc" id="L152" title="All 2 branches covered.">		if(fundById.getMoney()== 0.0) {</span>
<span class="fc" id="L153">			model.addAttribute(&quot;myFundEditable&quot;, &quot;YES&quot;);</span>
		}else {
<span class="fc" id="L155">			model.addAttribute(&quot;myFundEditable&quot;, &quot;NO&quot;);</span>
		}
<span class="fc" id="L157">		return &quot;fund&quot;;</span>
	}
	
	@GetMapping(&quot;/userfund/{id_fund}&quot;)
	public String editUserFund(@PathVariable Long id_fund, @ModelAttribute(&quot;user&quot;) User user, Model model) {
<span class="fc" id="L162">		Fund fundById = fundService.getFundById(id_fund);</span>
<span class="fc" id="L163">		model.addAttribute(&quot;fundAttribute&quot;, fundById);</span>
<span class="fc" id="L164">		model.addAttribute(&quot;myFundEditable&quot;, &quot;NO&quot;);</span>
<span class="fc" id="L165">		model.addAttribute(&quot;donate&quot;, &quot;YES&quot;);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">		if(user.getRole() == 1) {</span>
<span class="fc" id="L167">			model.addAttribute(&quot;closable&quot;, &quot;NO&quot;);</span>
		} else {
<span class="fc" id="L169">			model.addAttribute(&quot;closable&quot;, &quot;YES&quot;);</span>
		}
		
<span class="fc" id="L172">		return &quot;fund&quot;;</span>
	}

	@PostMapping(&quot;/closes&quot;)
	public String userClosesFund(Model model, Fund fund, @ModelAttribute(&quot;user&quot;) User user) {
<span class="fc bfc" id="L177" title="All 2 branches covered.">		if(user.getRole() == 1) {</span>
<span class="fc" id="L178">			fundService.userClosesFund(fund.getId_fund());</span>
		} else {
<span class="fc" id="L180">			fundService.adminClosesFund(fund.getId_fund());</span>
		}
<span class="fc" id="L182">		return home(model, user);</span>
	}
	
	@PostMapping(&quot;/edit-subject&quot;)
	public String editFundSubject(Model model, Fund fund, @ModelAttribute(&quot;user&quot;) User user) {
<span class="fc" id="L187">		final Long id = fund.getId_fund();</span>
<span class="fc" id="L188">		fundService.updateFundById(id, fund);</span>
<span class="fc" id="L189">		return home(model, user);</span>
	}
	
	@PostMapping(&quot;/action/donate&quot;)
	public String donateMoney(Model model, @ModelAttribute(&quot;donation&quot;) Double donation, Fund fund, @ModelAttribute(&quot;user&quot;) User user) {
		
<span class="fc" id="L195">		fundService.donateMoneyToFund(donation, fund.getId_fund());</span>
		
<span class="fc" id="L197">		System.out.println(&quot;Donation of &quot; + donation + &quot;, in Fund: &quot; + fund.toString());</span>
<span class="fc" id="L198">		return home(model, user);</span>
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.3.201901230119</span></div></body></html>